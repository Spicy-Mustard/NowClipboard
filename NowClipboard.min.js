/**
 * NowClipboard
 * 现代剪贴板工具库 - 基于 Clipboard API + execCommand 降级 + Node.js 适配
 * 零依赖，支持浏览器和 Node.js 环境
 */
!function(e,t){"object"==typeof module&&"object"==typeof module.exports?module.exports=t():"function"==typeof define&&define.amd?define([],t):e.NowClipboard=t()}("undefined"!=typeof self?self:this,function(){"use strict";var o="undefined"!=typeof window&&"undefined"!=typeof document,i="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;function c(e){return"string"==typeof e||e instanceof String}function a(e){return"function"==typeof e}function s(e){return null!=e&&"object"==typeof e&&1===e.nodeType}function u(){return o&&"undefined"!=typeof navigator&&null!=navigator.clipboard&&"function"==typeof navigator.clipboard.writeText}function r(){this._events={}}function l(e){var t="",r=e.nodeName;if("SELECT"===r)e.focus(),t=e.value;else if("INPUT"===r||"TEXTAREA"===r){r=e.hasAttribute("readonly");r||e.setAttribute("readonly",""),e.select();try{e.setSelectionRange(0,e.value.length)}catch(e){}r||e.removeAttribute("readonly"),t=e.value}else{e.hasAttribute("contenteditable")&&e.focus();var r=window.getSelection(),n=document.createRange();n.selectNodeContents(e),r.removeAllRanges(),r.addRange(n),t=r.toString()}return t}function d(){try{var e;window.getSelection&&((e=window.getSelection()).removeAllRanges?e.removeAllRanges():e.empty&&e.empty())}catch(e){}}function f(e){return navigator.clipboard.writeText(e).then(function(){return e})}function n(e,t){o=e,(r=document.createElement("textarea")).style.fontSize="12pt",r.style.border="0",r.style.padding="0",r.style.margin="0",r.style.position="absolute",r.style.opacity="0",n="rtl"===document.documentElement.getAttribute("dir"),r.style[n?"right":"left"]="-9999px",n=window.pageYOffset||document.documentElement.scrollTop,r.style.top=n+"px",r.setAttribute("readonly",""),r.value=o;var r,n=r,o=((t||document.body).appendChild(n),l(n),!1);try{o=document.execCommand("copy")}catch(e){o=!1}return n.remove(),d(),o?v(e):g(new Error("execCommand copy failed"))}function p(e,t){var e=l(e),r=!1;try{r=document.execCommand("copy")}catch(e){r=!1}return r?v(e):n(e,t)}function m(r){var e=l(r),t=!1;try{t=document.execCommand("cut")}catch(e){t=!1}return t?v(e):h(e).then(function(e){var t=r.nodeName;return"INPUT"===t||"TEXTAREA"===t?r.value="":r.hasAttribute("contenteditable")&&(r.innerHTML=""),e})}function h(e,t){var t=t||{},r=t.container||(o?document.body:null);return y(function(){var c;return u()?f(e).catch(function(){return o?n(e,r):g(new Error("Clipboard API failed and no fallback available"))}):o?n(e,r):i?(c=e,i?new Promise(function(t,r){var n,i=process.platform,e="win32"===i?(n="clip",[]):"darwin"===i?(n="pbcopy",[]):(n="xclip",["-selection","clipboard"]);try{var o=(0,require("child_process").spawn)(n,e,{stdio:["pipe","ignore","ignore"]}),a=!1;o.on("error",function(e){var o;a||(a=!0,"win32"!==i&&"darwin"!==i?(o=c,new Promise(function(t,r){try{var e=(0,require("child_process").spawn)("xsel",["--clipboard","--input"],{stdio:["pipe","ignore","ignore"]}),n=!1;e.on("error",function(e){n||(n=!0,r(new Error("No clipboard command available. Install xclip or xsel. "+e.message)))}),e.on("close",function(e){n||(n=!0,0===e?t(o):r(new Error("xsel exited with code: "+e)))}),e.stdin.write(o),e.stdin.end()}catch(e){r(new Error("Failed to spawn xsel: "+e.message))}}).then(t,r)):r(new Error("Clipboard command failed: "+n+" - "+e.message)))}),o.on("close",function(e){a||(a=!0,0===e?t(c):r(new Error("Clipboard command exited with code: "+e)))}),o.stdin.write(c),o.stdin.end()}catch(e){r(new Error("Failed to spawn clipboard process: "+e.message))}}):g(new Error("Not running in Node.js environment"))):g(new Error("No clipboard method available in this environment"))},t)}function e(e){return y(function(){return o&&"undefined"!=typeof navigator&&null!=navigator.clipboard&&"function"==typeof navigator.clipboard.readText?navigator.clipboard.readText():i?i?new Promise(function(t,r){var n,o=process.platform,e="win32"===o?(n="powershell",["-command","Get-Clipboard"]):"darwin"===o?(n="pbpaste",[]):(n="xclip",["-selection","clipboard","-o"]);try{var i=(0,require("child_process").spawn)(n,e,{stdio:["ignore","pipe","ignore"]}),a="",c=!1;i.stdout.on("data",function(e){a+=e.toString()}),i.on("error",function(e){c||(c=!0,"win32"!==o&&"darwin"!==o?new Promise(function(t,r){try{var e=(0,require("child_process").spawn)("xsel",["--clipboard","--output"],{stdio:["ignore","pipe","ignore"]}),n="",o=!1;e.stdout.on("data",function(e){n+=e.toString()}),e.on("error",function(e){o||(o=!0,r(new Error("No clipboard read command available. Install xclip or xsel. "+e.message)))}),e.on("close",function(e){o||(o=!0,0===e?t(n):r(new Error("xsel read exited with code: "+e)))})}catch(e){r(new Error("Failed to spawn xsel for read: "+e.message))}}).then(t,r):r(new Error("Clipboard read command failed: "+n+" - "+e.message)))}),i.on("close",function(e){c||(c=!0,0===e?t("win32"===o?a.replace(/\r?\n$/,""):a):r(new Error("Clipboard read command exited with code: "+e)))})}catch(e){r(new Error("Failed to spawn clipboard read process: "+e.message))}}):g(new Error("Not running in Node.js environment")):g(new Error("Clipboard read not supported in this environment"))},e||{})}function y(e,t){var o,i,n="number"==typeof(t=t)?{retries:t,retryDelay:100,timeout:0}:{retries:null!=(t=t||{}).retries?t.retries:2,retryDelay:null!=t.retryDelay?t.retryDelay:100,timeout:null!=t.timeout?t.timeout:0},a=0;return o=function r(){return e().catch(function(e){var t;return a++,n.retries<a?g(e):(t=Math.pow(2,a-1)*n.retryDelay,new Promise(function(e){setTimeout(e,t)}).then(r))})}(),!(i=n.timeout)||i<=0?o:new Promise(function(t,r){var n=setTimeout(function(){r(new Error("Operation timed out after "+i+"ms"))},i);o.then(function(e){clearTimeout(n),t(e)},function(e){clearTimeout(n),r(e)})})}function v(e){return Promise.resolve(e)}function g(e){return Promise.reject(e)}function t(e,t){e="data-nc-"+e;if(t.hasAttribute(e))return t.getAttribute(e)}function w(e,r,t,n){function o(e){var t=function(e,t){if(e.closest)return e.closest(t);for(var r,n,o,i=e;i&&1===i.nodeType;){if(n=t,o=void 0,(o=(r=i).matches||r.matchesSelector||r.msMatchesSelector||r.mozMatchesSelector||r.webkitMatchesSelector||r.oMatchesSelector)&&o.call(r,n))return i;i=i.parentNode}return null}(e.target,r);t&&n.call(e.delegateTarget=t,e)}return e.addEventListener(t,o,!1),{destroy:function(){e.removeEventListener(t,o,!1)}}}function b(e,t,r){if(c(e))return w(document.body,e,t,r);if(s(e))return e.addEventListener(t,r,!1),{destroy:function(){e.removeEventListener(t,r,!1)}};if(i=e,a=Object.prototype.toString.call(i),null!=i&&("[object NodeList]"===a||"[object HTMLCollection]"===a)&&"length"in i&&(0===i.length||s(i[0]))){for(var n=[],o=0;o<e.length;o++)!function(e){e.addEventListener(t,r,!1),n.push(function(){e.removeEventListener(t,r,!1)})}(e[o]);return{destroy:function(){for(var e=0;e<n.length;e++)n[e]()}}}var i,a;throw new TypeError("First argument must be a String selector, HTMLElement, or NodeList")}function E(e,n){if(!a(n))throw new TypeError("Callback must be a function");function t(e){var t=e.delegateTarget||e.currentTarget||e.target,r=function(e){var t={text:"",html:"",files:[]};if(e){try{t.text=e.getData("text/plain")||""}catch(e){}try{t.html=e.getData("text/html")||""}catch(e){}try{e.files&&0<e.files.length&&(t.files=Array.prototype.slice.call(e.files))}catch(e){}}return t}(e.clipboardData);r.originalEvent=e,r.trigger=t,n(r)}if(null==e)return document.addEventListener("paste",t,!1),{destroy:function(){document.removeEventListener("paste",t,!1)}};if(c(e))return w(document.body,e,"paste",t);if(s(e))return e.addEventListener("paste",t,!1),{destroy:function(){e.removeEventListener("paste",t,!1)}};throw new TypeError("Target must be a String selector, HTMLElement, or null")}function x(e,t){if(!(this instanceof x))return new x(e,t);r.call(this),this._destroyed=!1,this._listener=null,this.resolveOptions(t||{}),o&&e&&this.listenClick(e)}return r.prototype.on=function(e,t,r){return c(e)&&a(t)&&(this._events[e]||(this._events[e]=[])).push({fn:t,ctx:r,once:!1}),this},r.prototype.once=function(e,t,r){return c(e)&&a(t)&&(this._events[e]||(this._events[e]=[])).push({fn:t,ctx:r,once:!0}),this},r.prototype.off=function(e,t){if(c(e)){var r=this._events[e];if(r)if(t){for(var n=[],o=0;o<r.length;o++)r[o].fn!==t&&n.push(r[o]);n.length?this._events[e]=n:delete this._events[e]}else delete this._events[e]}return this},r.prototype.emit=function(e){var t=this._events[e];if(t&&0!==t.length){for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);for(var o=t.slice(),i=[],a=0;a<o.length;a++)o[a].fn.apply(o[a].ctx,r),o[a].once&&i.push(o[a]);if(i.length){for(var c=[],s=0;s<t.length;s++)-1===i.indexOf(t[s])&&c.push(t[s]);c.length?this._events[e]=c:delete this._events[e]}}return this},r.prototype.removeAllListeners=function(){return this._events={},this},((x.prototype=Object.create(r.prototype)).constructor=x).prototype.resolveOptions=function(e){this.action=a(e.action)?e.action:this.defaultAction,this.target=a(e.target)?e.target:this.defaultTarget,this.text=a(e.text)?e.text:this.defaultText,this.container=s(e.container)?e.container:o?document.body:null,this.retries=null!=e.retries?e.retries:2,this.retryDelay=null!=e.retryDelay?e.retryDelay:100,this.timeout=null!=e.timeout?e.timeout:0},x.prototype.listenClick=function(e){var t=this;this._listener=b(e,"click",function(e){t.onClick(e)})},x.prototype.onClick=function(e){var t,r,n,o=e.delegateTarget||e.currentTarget,i=this.action(o)||"copy",e=this.target(o),a=this.text(o),c=this;if("copy"!==i&&"cut"!==i)c.emit("error",{action:i,trigger:o,error:new Error('Invalid action "'+i+'", use "copy" or "cut"'),clearSelection:d});else{if(a)t=h(a,{container:c.container,retries:c.retries,retryDelay:c.retryDelay,timeout:c.timeout});else{if(!e)return void c.emit("error",{action:i,trigger:o,error:new Error("No text or target specified"),clearSelection:d});if("cut"===i){if(e.hasAttribute("readonly")||e.hasAttribute("disabled"))return void c.emit("error",{action:i,trigger:o,error:new Error('Cannot cut from elements with "readonly" or "disabled" attributes'),clearSelection:d});t=m(e)}else{if(e.hasAttribute("disabled"))return void c.emit("error",{action:i,trigger:o,error:new Error('Cannot copy from elements with "disabled" attribute, use "readonly" instead'),clearSelection:d});r=e,a={container:c.container,retries:c.retries,retryDelay:c.retryDelay,timeout:c.timeout},n=(a=a||{}).container||document.body,t=y(function(){var e=l(r);return u()?f(e).catch(function(){return d(),p(r,n)}):p(r,n)},a)}}t.then(function(e){c.emit("success",{action:i,text:e,trigger:o,clearSelection:d})}).catch(function(e){c.emit("error",{action:i,trigger:o,error:e,clearSelection:d})})}},x.prototype.defaultAction=function(e){return t("action",e)||"copy"},x.prototype.defaultTarget=function(e){e=t("target",e);if(e)return document.querySelector(e)},x.prototype.defaultText=function(e){return t("text",e)},x.prototype.destroy=function(){this._destroyed||(this._destroyed=!0,this._listener&&(this._listener.destroy(),this._listener=null),this.removeAllListeners(),this.action=null,this.target=null,this.text=null,this.container=null)},x.copy=function(e,t){return c(e)?h(e,t):g(new TypeError("NowClipboard.copy() expects a string argument"))},x.cut=function(e){return o?s(e)?m(e):g(new TypeError("NowClipboard.cut() expects an HTMLElement argument")):g(new Error("NowClipboard.cut() is only available in browser environment"))},x.read=e,x.checkSupport=function(e){if(i)return!0;if(!o)return!1;if(u())return!0;for(var t=e||["copy","cut"],r=(c(t)&&(t=[t]),!0),n=0;n<t.length;n++)r=r&&function(e){if(!o)return!1;try{return!!document.queryCommandSupported&&document.queryCommandSupported(e)}catch(e){return!1}}(t[n]);return r},x.queryPermission=function(e){if("read"!==e&&"write"!==e)return g(new TypeError('queryPermission() expects "read" or "write"'));if(i)return v({state:"granted"});e="clipboard-"+e;if(!o||"undefined"==typeof navigator||!navigator.permissions||!a(navigator.permissions.query))return v({state:"prompt"});try{return navigator.permissions.query({name:e}).then(function(e){return{state:e.state}}).catch(function(){return{state:"prompt"}})}catch(e){return v({state:"prompt"})}},x.onPaste=function(e,t){if(o)return E(e,t);throw new Error("NowClipboard.onPaste() is only available in browser environment")},x});